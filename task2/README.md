# Задание №2

**Условие:** 

У вас есть база размером свыше 100гб и более 8млн строк. Вам необходимо добавить 3 новых поля, переименовать одно поле, а также добавить два индекса. Опишите, как вы это будете делать?

**Решение:**

Если бизнес допускает остановку, то ночью певодим сайт в режим сервисного обслуживания, делаем бэкап, вносим изменения, открываем.

Если бизнес не допускает остановку или его мнение не известно, то при наличии места на диске

1. Для MySQL можно выполнить миграцию через бинарный лог с помощью этой утилиты: https://github.com/github/gh-ost Для PostgreSQL с помощью этой: https://databaseci.com/docs/migra 

Обе утилиты имеют ограничения. Например, gh-ost не поддерживает внешние ключи и триггеры.

2. Если делать всё руками, то последовательность будет примерно следующая:

+ Создаём таблицу для отслеживания изменений 
+ Пишем скрипт, который будет вносить изменения из таблицы отслеживания в новую таблицу
+ Создаём для боевой таблицы триггеры отслеживающие изменения
+ Делаем копию боевой таблицы и в этой новой таблице вносим необходимые изменения в структуру и индексы
+ Блокируем основную таблицу на запись
+ Запускаем скрипт по переносу данных из таблицы изменений
+ После завершения переключаемся на новую таблицу

Так можно добиться минимального простоя, но есть небольшое окно (пункт 6 и 7), когда данные UPDATE / DELETE могут быть потеряны.

3. Если база данных имеет реплику (slave), то можно внести изменения в реплику и переключить её в мастер. Но судя по мануалам простоя избежать не получится.
